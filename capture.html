<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Live Capture — Seasoning</title>
  <link rel="stylesheet" href="styles.css">
  <!-- OpenCV.js (official CDN) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>
<body>
  <div class="container">
    <h2>Live Capture</h2>

    <div class="cameraBox">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay" class="overlay"></canvas>
    </div>

    <div class="controls">
      <button id="captureBtn" class="button">Capture & Analyze</button>
      <button class="button" onclick="location.href='index.html'">Back</button>
    </div>

    <div id="result" class="result">Coverage: —</div>
    <div class="small">Tip: hold phone top-down, keep single chip near center.</div>
  </div>

  <script src="analysis.js"></script>
  <script>
    // start camera
    async function startCamera(){
      try {
        const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
        const video = document.getElementById('video');
        video.srcObject = s;
        await video.play();
        // size overlay to video actual pixels
        const overlay = document.getElementById('overlay');
        function resize(){
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          overlay.style.width = video.clientWidth + 'px';
          overlay.style.height = video.clientHeight + 'px';
        }
        video.addEventListener('loadedmetadata', resize);
        window.addEventListener('resize', resize);
      } catch(err){
        alert('Allow camera access or use Upload mode.');
      }
    }
    startCamera();

    document.getElementById('captureBtn').addEventListener('click', async ()=>{
      const video = document.getElementById('video');
      if (!video.videoWidth || !video.videoHeight){ alert('Camera not ready'); return; }
      // draw video frame on temp canvas, pass to analyzer
      const tmp = document.createElement('canvas');
      tmp.width = video.videoWidth; tmp.height = video.videoHeight;
      tmp.getContext('2d').drawImage(video,0,0);
      await analyzeElementAndShow(tmp, document.getElementById('overlay'), document.getElementById('result'));
    });
  </script>
</body>
</html>
